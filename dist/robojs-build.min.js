!function(a,b){b(a)}("undefined"!=typeof window?window:this,function(a){function b(){this.onAdded=new h.Signal,this.onRemoved=new h.Signal;var a=new MutationObserver(this.handleMutations.bind(this));a.observe(document.body,{attributes:!1,childList:!0,characterData:!1})}function c(a,b,c,d,e){this.dispatcher=a,this.eventString=b,this.listener=c,this.callback=d,this.scope=e}function d(){this._listeners=[]}function e(a){this.element=a,this.eventMap=new d,this.eventDispatcher=j.getInstance()}function f(){}function g(a){this.onAdded=new h.Signal,this.onRemoved=new h.Signal,this.definitions=a||[],this.displayList=new b,this.displayList.onAdded.add(this._handleNodesAdded,this),this.displayList.onRemoved.add(this._handleNodesRemoved,this)}var RoboJS={org:{}},h=require("signals"),i=require("lodash");b.prototype={handleMutations:function(a){var b=i.reduce(a,function(a,b){return a.addedNodes=a.addedNodes.concat(Array.prototype.slice.call(b.addedNodes)),a.removedNodes=a.removedNodes.concat(Array.prototype.slice.call(b.removedNodes)),a},{addedNodes:[],removedNodes:[]});b.addedNodes.length&&this.onAdded.dispatch(b.addedNodes),b.removedNodes.length&&this.onRemoved.dispatch(b.removedNodes)}},module.exports=b,function(a,b){"function"==typeof define&&define.amd?define("EventDispatcher",[],b):"object"==typeof exports?module.exports=b:a.EventDispatcher=b}(this,function(){function a(){this._currentListeners={}}a.prototype={addEventListener:function(a,b,c){var d={type:a,callback:b,scope:c};return this._currentListeners[a]||(this._currentListeners[a]=[]),this._currentListeners[a].push(d),d},removeEventListener:function(a,b,c){var d=this._currentListeners[a]||[];this._currentListeners[a]=d.filter(function(a){var d=a.callback==b,e=a.scope==c;return!(d&&e)})},removeAllEventListeners:function(a){this._currentListeners[a]=null},hasEventListener:function(a){return this._currentListeners[a]&&this._currentListeners[a].length},dispatchEvent:function(a,b){for(var c,d,e,f=this._currentListeners[a]||[],g=f.length,h=0;g>h;h++)c=f[h],d=c.callback,e=c.scope,d.call(e,b)}};var b;return a.getInstance=function(){"use strict";return b||(b=new a),b},a}),c.prototype={equalTo:function(a,b,c){return this.eventString==b&&this.dispatcher==a&&this.listener==c}},module.exports=c;var c=require("./EventMapConfig");d.prototype={mapListener:function(a,b,d,e){for(var f,g=this._listeners,h=g.length;h--;)if(f=g[h],f.equalTo(a,b,d))return;var i=d;f=new c(a,b,d,i,e),g.push(f),a.addEventListener(b,i,e)},unmapListener:function(a,b,c){for(var d=this._listeners,e=d.length;e--;){var f=d[e];if(f.equalTo(a,b,c))return a.removeEventListener(b,f.callback,f.scope),void d.splice(e,1)}},unmapListeners:function(){for(var a,b,c=this._listeners;a=c.pop();)b=a.dispatcher,b.removeEventListener(a.eventString,a.callback,a.scope)}},module.exports=d;var j=require("EventDispatcher"),d=require("../events/EventMap");e.prototype={postDestroy:function(){console.log("postDestroy"),this.eventMap.unmapListeners()},addContextListener:function(a,b,c){this.eventMap.mapListener(this.eventDispatcher,a,b,c)},removeContextListener:function(a,b){this.eventMap.unmapListener(this.eventDispatcher,a,b)},dispatch:function(a){this.eventDispatcher.hasEventListener(a)&&this.eventDispatcher.dispatchEvent(a)},initialize:function(){console.log("Mediator",this)},destroy:function(){}},module.exports=e;var k=require("bluebird");f.prototype={require:function(a){return new k(function(b){require([a],function(a){b(a)})})}},module.exports=new f;var b=require("./DisplayList"),f=require("../net/ScriptLoader"),h=require("signals"),i=require("lodash"),k=require("bluebird"),l={},m={uid:["0","0","0"],nextUid:function(){for(var a,b=m.uid.length;b;){if(b--,a=m.uid[b].charCodeAt(0),57==a)return m.uid[b]="A",m.uid.join("");if(90!=a)return m.uid[b]=String.fromCharCode(a+1),m.uid.join("");m.uid[b]="0"}return m.uid.unshift("0"),m.uid.join("")}};g.prototype={bootstrap:function(){return this.getMediators([document.body])},getMediators:function(a){var b=i.chain(a).reduce(this._reduceNodes,[]).reduce(this._findMediators.bind(this),[]).value();return k.all(b)},_findMediators:function(a,b){var c=i.partial(this._initMediator,b),d=i.chain(this.definitions).filter(function(a){return b.dataset&&b.dataset.mediator==a.id}).map(function(a){return f.require(a.mediator).then(c)}).value();return a.concat(d)},_initMediator:function(a,b){var c=m.nextUid();a.dataset=a.dataset||{},a.dataset.mediatorId=c;var d=new b(a);return d.id=c,l[c]=d,d.initialize(),d},_handleNodesAdded:function(a){this.getMediators(a).then(function(a){a.length&&this.onAdded.dispatch(a)}.bind(this))},_handleNodesRemoved:function(a){console.log("_handleNodesRemoved"),i.chain(a).reduce(this._reduceNodes,[]).forEach(this._destroyMediator.bind(this))},_reduceNodes:function(a,b){var c=[].slice.call(b.getElementsByTagName("*"),0);return c.unshift(b),a.concat(c)},_destroyMediator:function(a){var b=a.dataset&&a.dataset.mediatorId,c=l[b];c&&(c.destroy&&c.destroy(),c.postDestroy&&c.postDestroy(),c.element&&(c.element=null)),this.onRemoved.dispatch(c),l[b]=null,c=null}},module.exports=g,RoboJS.org.display={DisplayList:b,Mediator:e,MediatorsBuilder:g},RoboJS.org.events={EventDispatcher:j,EventMap:d,EventMapConfig:c},RoboJS.org.net={ScriptLoader:f},"function"==typeof define&&define.amd?define("RoboJS",[],function(){return RoboJS}):a.RoboJS=RoboJS});