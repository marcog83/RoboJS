!function(e,t){if("function"==typeof define&&define.amd)define("robojs",["exports"],t);else if("undefined"!=typeof exports)t(exports);else{var n={};t(n),e.robojs=n}}(this,function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),r=function(){function e(){l(this,e)}return i(e,[{key:"load",value:function(n){var i=this;return new Promise(function(e,t){return i.onComplete(n,e,t)})}},{key:"onComplete",value:function(e,t,n){}}]),e}(),u=function(e){function t(){return l(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,r),i(t,[{key:"onComplete",value:function(e,t,n){window.require([e],t,n)}}]),t}(),t=(function(){function e(){l(this,e),this.listeners_={}}i(e,[{key:"addEventListener",value:function(e,t){if(e in this.listeners_){var n=this.listeners_[e];n.indexOf(t)<0&&n.push(t)}else this.listeners_[e]=[t]}},{key:"removeEventListener",value:function(e,t){if(e in this.listeners_){var n=this.listeners_[e],i=n.indexOf(t);0<=i&&(1===n.length?delete this.listeners_[e]:n.splice(i,1))}}},{key:"dispatchEvent",value:function(e){var t=this;e.__defineGetter__("target",function(){return t});var n=e.type,i=0;if(n in this.listeners_)for(var r=this.listeners_[n].concat(),o=0;o<r.length;o++){var s=r[o];s.handleEvent?i|=!1===s.handleEvent.call(s,e):i|=!1===s.call(this,e)}return!i&&!e.defaultPrevented}}])}(),(("undefined"==typeof global?"undefined":n(global))===n(null)?global:self).EventTarget),s=t,o=function(){function e(){l(this,e),this.listenerBoxes=[],this.listenersNeedCloning=!1}return i(e,[{key:"getNumListeners",value:function(){return this.listenerBoxes.length}},{key:"connect",value:function(e,t){this.registerListener(e,t,!1)}},{key:"connectOnce",value:function(e,t){this.registerListener(e,t,!0)}},{key:"disconnect",value:function(e,t){this.listenersNeedCloning&&(this.listenerBoxes=this.listenerBoxes.slice(),this.listenersNeedCloning=!1);for(var n=this.listenerBoxes.length;n--;)if(this.listenerBoxes[n].listener==e&&this.listenerBoxes[n].scope==t)return void this.listenerBoxes.splice(n,1)}},{key:"disconnectAll",value:function(){for(var e=this.listenerBoxes.length;e--;)this.disconnect(this.listenerBoxes[e].listener,this.listenerBoxes[e].scope)}},{key:"emit",value:function(){for(var i=this,e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];this.listenersNeedCloning=!0,this.listenerBoxes.forEach(function(e){var t=e.scope,n=e.listener;e.once&&i.disconnect(n,t),n.apply(t,r)}),this.listenersNeedCloning=!1}},{key:"registerListener",value:function(t,n,i){var e=this.listenerBoxes.filter(function(e){return e.listener===t&&e.scope===n});if(e.length){var r=e.find(function(e){return e.once&&!i}),o=e.find(function(e){return i&&!e.once});if(r)throw Error("You cannot addOnce() then try to add() the same listener without removing the relationship first.");if(o)throw Error("You cannot add() then addOnce() the same listener without removing the relationship first.")}else this.listenersNeedCloning&&(this.listenerBoxes=this.listenerBoxes.slice()),this.listenerBoxes.push({listener:t,scope:n,once:i})}}]),e}();function a(e,h){switch(e){case 0:return function(){return h.apply(this,arguments)};case 1:return function(e){return h.apply(this,arguments)};case 2:return function(e,t){return h.apply(this,arguments)};case 3:return function(e,t,n){return h.apply(this,arguments)};case 4:return function(e,t,n,i){return h.apply(this,arguments)};case 5:return function(e,t,n,i,r){return h.apply(this,arguments)};case 6:return function(e,t,n,i,r,o){return h.apply(this,arguments)};case 7:return function(e,t,n,i,r,o,s){return h.apply(this,arguments)};case 8:return function(e,t,n,i,r,o,s,l){return h.apply(this,arguments)};case 9:return function(e,t,n,i,r,o,s,l,u){return h.apply(this,arguments)};case 10:return function(e,t,n,i,r,o,s,l,u,a){return h.apply(this,arguments)};default:throw Error("First argument to _arity must be a non-negative integer no greater than ten")}}var h=function(e){return e};function c(e){var t,n=e.length;return 1===n?(t=e,function e(){return 0===arguments.length?e:t.apply(this,arguments)}):a(n,function o(s,l,u){return function(){for(var e=[],t=0,n=s,i=0;i<l.length||t<arguments.length;){var r=void 0;i<l.length?r=l[i]:(r=arguments[t],t+=1),e[i]=r,n-=1,i+=1}return n<=0?u.apply(this,e):a(n,o(s,e,u))}}(n,[],e))}c(function(e,t,n){for(var i=0,r=n.length;i<r;)t=e(t,n[i]),i+=1;return t});var d=c(function(e,t){for(var n=0,i=t.length,r=[];n<i;)e(t[n])&&(r[r.length]=t[n]),n+=1;return r}),f=c(function(e,t){for(var n=0,i=t.length;n<i;){if(e(t[n]))return t[n];n+=1}}),v=function(e){return null!=e&&0<=e.length&&"[object Array]"===Object.prototype.toString.call(e)};function p(e){var t;return!!e&&(!!(Array.isArray||v)(e)||"object"===(void 0===e?"undefined":n(e))&&(t=e,"[object String]"!==Object.prototype.toString.call(t)&&(1===e.nodeType?!!e.length:0===e.length||0<e.length&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}function y(e){for(var t=void 0,n=void 0,i=void 0,r=[],o=0,s=e.length;o<s;){if(p(e[o]))for(i=0,n=(t=y(e[o])).length;i<n;)r[r.length]=t[i],i+=1;else r[r.length]=e[o];o+=1}return r}c(function(e,t){for(var n=t.length,i=0;i<n;)e(t[i]),i+=1;return t});var g=c(function(e,t){for(var n=0,i=t.length,r=[];n<i;n++)r[n]=e(t[n]);return r});function m(e){return e.filter(function(e,t,n){return n.indexOf(e)==t})}c(function(t,e){return g(function(e){return e[t]},e)});var b=function(){function n(e,t){l(this,n),this.onAdded=new o,this.onRemoved=new o,this.root=e,this.getAllElements=t,this.init()}return i(n,[{key:"init",value:function(){this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(this.root,{attributes:!1,childList:!0,characterData:!1,subtree:!0})}},{key:"handleMutations",value:function(e){var t=this;e.forEach(function(e){t.getRemoved(e.removedNodes),t.getAdded(e.addedNodes)})}},{key:"getAdded",value:function(e){var t=y(e);return 0<(t=m(t=y(t=t.filter(function(e){return e.querySelectorAll}).map(this.getAllElements).filter(function(e){return 0<e.length})))).length?this.onAdded.emit(t):[]}},{key:"getRemoved",value:function(e){var t=y(e);return 0<(t=m(t=y(t=t.filter(function(e){return e.querySelectorAll}).map(this.getAllElements).filter(function(e){return 0<e.length})))).length?this.onRemoved.emit(t):[]}},{key:"dispose",value:function(){this.observer.disconnect(),this.onAdded.disconnectAll(),this.onRemoved.disconnectAll(),this.observer=null,this.onAdded=null,this.onRemoved=null}}]),n}(),x=/[xy]/g,A=function(){function o(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l(this,o);var t=e.definitions,n=void 0===t?{}:t,i=e.dispatcher,r=void 0===i?new s:i;this.definitions=n,this.dispatcher=r,this.MEDIATORS_CACHE=[]}return i(o,[{key:"getDefinition",value:function(e){return this.definitions[e.getAttribute(this.selector)]}},{key:"inCache",value:function(t){return!!f(function(e){return e.node===t},this.MEDIATORS_CACHE)}},{key:"updateCache",value:function(e){return this.MEDIATORS_CACHE.push(e),this.MEDIATORS_CACHE}},{key:"hasMediator",value:function(e){return!!this.getDefinition(e)&&!this.inCache(e)}},{key:"findMediator",value:function(e,t){var n=this;return e(this.getDefinition(t)).then(function(e){return n.create(t,e)}).then(this.updateCache.bind(this))}},{key:"create",value:function(e,t){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(x,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});e.setAttribute("mediatorid",n);var i={mediatorId:n,node:e,dispose:h};e.parentNode&&(i={mediatorId:n,node:e,dispose:t(e,this.dispatcher)||h});return i}},{key:"getAllElements",value:function(e){var t=[].slice.call(e.querySelectorAll("["+this.selector+"]"),0);return e.getAttribute(this.selector)&&t.unshift(e),t}},{key:"disposeMediator",value:function(e){e&&(e.dispose(),e.node=null)}},{key:"_destroy",value:function(e){for(var t=this.MEDIATORS_CACHE.length,n=0;n<t;n++){var i=this.MEDIATORS_CACHE[n];i?i.node&&i.node!==e||(i.dispose&&i.dispose(),i.node=null,this.MEDIATORS_CACHE[n]=null):this.MEDIATORS_CACHE[n]=null}return this.MEDIATORS_CACHE.filter(function(e){return e})}},{key:"destroy",value:function(e){return this.MEDIATORS_CACHE=this._destroy(e),this.MEDIATORS_CACHE}},{key:"dispose",value:function(){this.MEDIATORS_CACHE.forEach(this.disposeMediator),this.MEDIATORS_CACHE=null,this.dispatcher.listeners_=null,this.dispatcher=null}},{key:"selector",get:function(){return"data-mediator"}}]),o}(),E=function(){function s(e){l(this,s);var t=e.definitions,n=e.loader,i=void 0===n?new u:n,r=e.root,o=void 0===r?document.body:r;this.definitions=t,this.loader=i,this.root=o,this.handler=e.handler||new A({definitions:t}),this.domWatcher=e.domWatcher||new b(o,this.handler.getAllElements.bind(this.handler)),this.domWatcher.onAdded.connect(this.handleAdded.bind(this)),this.domWatcher.onRemoved.connect(this.handleRemoved.bind(this)),this.init()}return i(s,[{key:"init",value:function(){var e=[this.root].map(this.handler.getAllElements.bind(this.handler));this.promise=this.getMediators(e)}},{key:"handleAdded",value:function(e){var n=this,t=y(e);t=d(this.handler.hasMediator.bind(this.handler),t);var i=g(function(t){return n.loader.load(n.handler.getDefinition(t)).then(function(e){return n.handler.create(t,e)}).then(n.handler.updateCache.bind(n.handler))},t);return Promise.all(i)}},{key:"handleRemoved",value:function(e){e.forEach(this.handler.destroy.bind(this.handler))}},{key:"getMediators",value:function(e){var t=(e=y(e)).filter(this.handler.hasMediator.bind(this.handler)).map(this.handler.findMediator.bind(this.handler,this.loader.load.bind(this.loader)));return Promise.all(t)}},{key:"dispose",value:function(){this.domWatcher.dispose(),this.handler.dispose(),this.domWatcher=null,this.handler=null,this.definitions=null,this.loader=null,this.root=null,this.promise=null}}]),s}();e.bootstrap=function(e){return new E(e)},e.Loader=r,e.EventTarget=s,e.Signal=o,e.DomWatcher=b,e.MediatorHandler=A,e.Bootstrap=E});