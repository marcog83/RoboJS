!function(e,t){if("function"==typeof define&&define.amd)define("robojs",["exports"],t);else if("undefined"!=typeof exports)t(exports);else{var n={};t(n),e.robojs=n}}(this,function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),s=function(){function e(){a(this,e)}return i(e,[{key:"load",value:function(n){var i=this;return new Promise(function(e,t){return i.onComplete(n,e,t)})}},{key:"onComplete",value:function(e,t,n){}}]),e}(),l=function(e){function t(){return a(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,s),i(t,[{key:"onComplete",value:function(e,t,n){require([e],t,n)}}]),t}(),t=function(e){function n(e){a(this,n);var t=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t.fn=e,t}return o(n,s),i(n,[{key:"onComplete",value:function(e,t,n){this.fn(e,t,n)}}]),n}(),u=function(){function e(){a(this,e),this.listeners_={}}return i(e,[{key:"addEventListener",value:function(e,t){if(e in this.listeners_){var n=this.listeners_[e];n.indexOf(t)<0&&n.push(t)}else this.listeners_[e]=[t]}},{key:"removeEventListener",value:function(e,t){if(e in this.listeners_){var n=this.listeners_[e],i=n.indexOf(t);0<=i&&(1===n.length?delete this.listeners_[e]:n.splice(i,1))}}},{key:"dispatchEvent",value:function(e){var t=this;e.__defineGetter__("target",function(){return t});var n=e.type,i=0;if(n in this.listeners_)for(var r=this.listeners_[n].concat(),o=0;o<r.length;o++){var s=r[o];i=s.handleEvent?!1===s.handleEvent.call(s,e)?0:1:!1===s.call(this,e)?0:1}return!i&&!e.defaultPrevented}}]),e}(),h=(("undefined"==typeof global?"undefined":n(global))===n(null)?global:self).EventTarget;try{new h}catch(e){h=u}var c=h,d=function(){function e(){a(this,e),this.listenerBoxes=[],this.listenersNeedCloning=!1}return i(e,[{key:"getNumListeners",value:function(){return this.listenerBoxes.length}},{key:"connect",value:function(e,t){this.registerListener(e,t,!1)}},{key:"connectOnce",value:function(e,t){this.registerListener(e,t,!0)}},{key:"disconnect",value:function(e,t){this.listenersNeedCloning&&(this.listenerBoxes=this.listenerBoxes.slice(),this.listenersNeedCloning=!1);for(var n=this.listenerBoxes.length;n--;)if(this.listenerBoxes[n].listener==e&&this.listenerBoxes[n].scope==t)return void this.listenerBoxes.splice(n,1)}},{key:"disconnectAll",value:function(){for(var e=this.listenerBoxes.length;e--;)this.disconnect(this.listenerBoxes[e].listener,this.listenerBoxes[e].scope)}},{key:"emit",value:function(){for(var i=this,e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];this.listenersNeedCloning=!0,this.listenerBoxes.forEach(function(e){var t=e.scope,n=e.listener;e.once&&i.disconnect(n,t),n.apply(t,r)}),this.listenersNeedCloning=!1}},{key:"registerListener",value:function(t,n,i){var e=this.listenerBoxes.filter(function(e){return e.listener===t&&e.scope===n});if(e.length){var r=e.find(function(e){return e.once&&!i}),o=e.find(function(e){return i&&!e.once});if(r)throw Error("You cannot addOnce() then try to add() the same listener without removing the relationship first.");if(o)throw Error("You cannot add() then addOnce() the same listener without removing the relationship first.")}else this.listenersNeedCloning&&(this.listenerBoxes=this.listenerBoxes.slice()),this.listenerBoxes.push({listener:t,scope:n,once:i})}}]),e}(),f=function(e){return null!=e&&0<=e.length&&"[object Array]"===Object.prototype.toString.call(e)};function v(e){var t;return!!e&&(!!(Array.isArray||f)(e)||"object"===(void 0===e?"undefined":n(e))&&(t=e,"[object String]"!==Object.prototype.toString.call(t)&&(1===e.nodeType?!!e.length:0===e.length||0<e.length&&(e.hasOwnProperty(0)&&e.hasOwnProperty(e.length-1)))))}function p(e){for(var t=void 0,n=void 0,i=void 0,r=[],o=0,s=e.length;o<s;){if(v(e[o]))for(i=0,n=(t=p(e[o])).length;i<n;)r[r.length]=t[i],i+=1;else r[r.length]=e[o];o+=1}return r}function y(e){return e.filter(function(e,t,n){return n.indexOf(e)==t})}var m=function(){function n(e,t){a(this,n),this.onAdded=new d,this.onRemoved=new d,this.root=e,this.handler=t,this.init()}return i(n,[{key:"init",value:function(){this.observer=new MutationObserver(this.handleMutations.bind(this)),this.observer.observe(this.root,{attributes:!1,childList:!0,characterData:!1,subtree:!0})}},{key:"handleMutations",value:function(e){var t=this;e.forEach(function(e){t.getRemoved(e.removedNodes),t.getAdded(e.addedNodes)})}},{key:"getAdded",value:function(e){var t=p(e);0<(t=y(t=p(t=t.filter(function(e){return e.querySelectorAll}).map(this.handler.getAllElements.bind(this.handler)).filter(function(e){return 0<e.length})))).length&&this.onAdded.emit(t)}},{key:"getRemoved",value:function(e){var t=p(e);0<(t=y(t=p(t=t.filter(function(e){return e.querySelectorAll}).map(this.handler.getAllElements.bind(this.handler)).filter(function(e){return 0<e.length})))).length&&this.onRemoved.emit(t)}},{key:"dispose",value:function(){this.observer.disconnect(),this.onAdded.disconnectAll(),this.onRemoved.disconnectAll(),this.observer=null,this.onAdded=null,this.onRemoved=null}}]),n}(),g=function(e){return e},b=/[xy]/g,E=function(){function o(e){a(this,o);var t=e.definitions,n=void 0===t?{}:t,i=e.dispatcher,r=void 0===i?new c:i;this.definitions=n,this.dispatcher=r}return i(o,[{key:"getDefinition",value:function(e){throw Error("not implemented")}},{key:"inCache",value:function(e){throw Error("not implemented")}},{key:"updateCache",value:function(e){throw Error("not implemented")}},{key:"hasMediator",value:function(e){return!1}},{key:"create",value:function(e,t){throw Error("not implemented")}},{key:"getAllElements",value:function(e){throw Error("not implemented")}},{key:"destroy",value:function(e){}},{key:"dispose",value:function(){}}]),o}(),_=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=t.mediatorId,i=void 0===n?"":n,r=t.node,o=void 0===r?null:r,s=t.dispose,l=void 0===s?g:s;a(this,e),this.mediatorId=i,this.node=o,this.dispose=l},k=function(e){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};a(this,n);var t=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.MEDIATORS_CACHE=[],t}return o(n,E),i(n,[{key:"getDefinition",value:function(e){return this.definitions[e.getAttribute(this.selector)]}},{key:"inCache",value:function(t){return!!this.MEDIATORS_CACHE.find(function(e){return e.node===t})}},{key:"updateCache",value:function(e){return this.MEDIATORS_CACHE.push(e),this.MEDIATORS_CACHE}},{key:"hasMediator",value:function(e){return!!this.getDefinition(e)&&!this.inCache(e)}},{key:"create",value:function(e,t){var n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(b,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});e.setAttribute("mediatorid",n);var i=g;e.parentNode&&(i=t(e,this.dispatcher)||g);var r=new _({mediatorId:n,node:e,dispose:i});return this.updateCache(r),r}},{key:"getAllElements",value:function(e){var t=Array.from(e.querySelectorAll("["+this.selector+"]")).slice(0);return e.getAttribute(this.selector)&&t.unshift(e),t}},{key:"_destroy",value:function(e){for(var t=this.MEDIATORS_CACHE.length,n=0;n<t;n++){var i=this.MEDIATORS_CACHE[n];i?i.node&&i.node!==e||(i.dispose&&i.dispose(),i.node=null,this.MEDIATORS_CACHE[n]=null):this.MEDIATORS_CACHE[n]=null}return this.MEDIATORS_CACHE.filter(function(e){return e})}},{key:"destroy",value:function(e){return this.MEDIATORS_CACHE=this._destroy(e),this.MEDIATORS_CACHE}},{key:"dispose",value:function(){this.MEDIATORS_CACHE.forEach(n.disposeMediator),this.MEDIATORS_CACHE=null,this.dispatcher=null}},{key:"selector",get:function(){return"data-mediator"}}],[{key:"disposeMediator",value:function(e){e&&(e.dispose(),e.node=null)}}]),n}(),x=function(){function s(e){a(this,s);var t=e.definitions,n=e.loader,i=void 0===n?new l:n,r=e.root,o=void 0===r?document.body:r;this.definitions=t,this.loader=i,this.root=o,this.handler=e.handler||new k({definitions:t}),this.domWatcher=e.domWatcher||new m(o,this.handler),this.domWatcher.onAdded.connect(this.getMediators.bind(this)),this.domWatcher.onRemoved.connect(this.handleRemoved.bind(this)),this.init()}return i(s,[{key:"init",value:function(){var e=[this.root].map(this.handler.getAllElements.bind(this.handler));this.promise=this.getMediators(e)}},{key:"getMediators",value:function(e){var n=this,t=(e=p(e)).filter(this.handler.hasMediator.bind(this.handler)).map(function(t){var e=n.handler.getDefinition(t);return n.loader.load(e).then(function(e){return n.handler.create(t,e)})});return Promise.all(t)}},{key:"handleRemoved",value:function(e){e.forEach(this.handler.destroy.bind(this.handler))}},{key:"dispose",value:function(){this.domWatcher.dispose(),this.handler.dispose(),this.domWatcher=null,this.handler=null,this.definitions=null,this.loader=null,this.root=null,this.promise=null}}]),s}(),A=["a","abbr","acronym","address","applet","area","article","aside","audio","b","base","basefont","bdi","bdo","big","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","dir","div","dl","dt","em","embed","fieldset","figcaption","figure","font","footer","form","frame","frameset","h1 ","h2","h3","h4","h5","h6","head","header","hr","html","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meta","meter","nav","noframes","noscript","object","ol","optgroup","option","output","p","param","picture","pre","progress","q","rp","rt","ruby","s","samp","script","section","select","small","source","span","strike","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","tt","u","ul","var","video","wbr"].map(function(e){return":not("+e+")"}).reduce(function(e,t){return e+t},"*"),C=function(e){function n(e){a(this,n);var t=r(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.REGISTERED_ELEMENTS={},t}return o(n,E),i(n,[{key:"updateCache",value:function(e){return this.REGISTERED_ELEMENTS[e]=!0,this.REGISTERED_ELEMENTS}},{key:"inCache",value:function(e){return!!this.REGISTERED_ELEMENTS[e]}},{key:"getDefinition",value:function(e){return this.definitions[e.tagName.toLowerCase()]}},{key:"create",value:function(e,n){var t="",i=this.dispatcher;if(!this.inCache(e.tagName.toLowerCase())){if(!(t=e.tagName.toLowerCase()).match(/-/gim))throw Error("The name of a custom element must contain a dash (-). So <x-tags>, <my-element>, and <my-awesome-app> are all valid names, while <tabs> and <foo_bar> are not.");window.customElements.define(t,function(e){function t(){return a(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i))}return o(t,n),t}()),this.updateCache(t)}return new _}},{key:"hasMediator",value:function(e){var t=e.tagName.toLowerCase();return!!this.getDefinition(e)&&!this.inCache(t)}},{key:"getAllElements",value:function(e){return[e].concat([].slice.call(e.querySelectorAll(A),0))}},{key:"dispose",value:function(){}},{key:"destroy",value:function(e){}}]),n}();e.bootstrap=function(e){return new x(e)},e.Loader=s,e.AMDLoader=l,e.CustomLoader=t,e.EventTarget=c,e.Signal=d,e.DomWatcher=m,e.MediatorHandler=k,e.Robo=x,e.CustomElementHandler=C});